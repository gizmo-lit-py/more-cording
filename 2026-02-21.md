#2026-02-21
-今日やったこと：from flask import Flask, render_template, request, url_for, redirect, abort
from datetime import datetime
import db

app = Flask(__name__)


#アプリ起動時にDB初期化
db.init_db()

@app.route("/")
def home():
    conn = db.get_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM tracks ORDER BY id DESC")
    tracks = cursor.fetchall()
    conn.close()
    return render_template("index.html", tracks=tracks)


@app.route("/tracks/new",methods=["GET"])
def new_track():
    return render_template("tracks/new.html")

@app.route("/tracks", methods=["POST"])
def create_track():

    title = request.form["title"]
    artist = request.form["artist"]
    bpm = request.form["bpm"]
    key = request.form["key"]
    energy = request.form["energy"]
    genre = request.form["genre"]
    created_at = datetime.now().isoformat()

    conn = db.get_connection()
    cursor = conn.cursor()


    cursor.execute("""
                   INSERT INTO tracks (
                   title, artist, bpm, key, energy, genre, created_at)
                   VALUES (?, ?, ?, ?, ?, ?, ?)
                   """,
                   (
                       title,
                       artist,
                       bpm,
                       key,
                       energy,
                       genre,
                       created_at
                   )
                   )
    
    conn.commit()
    conn.close()
    return redirect(url_for("home"))

@app.route("/tracks/<int:track_id>")
def show_track(track_id):
    conn = db.get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "SELECT * FROM tracks WHERE id = ?",
        (track_id,)
    )
    track = cursor.fetchone()
    conn.close()

    if track is None:
        abort(404)

    return render_template("tracks/detail.html", track=track)

@app.route("/tracks/<int:track_id>/delete", methods=["POST"])
def delete_track(track_id):
    conn = db.get_connection()
    cursor = conn.cursor()
    cursor.execute(
        "DELETE FROM tracks WHERE id = ?",
        (track_id,)
    )
    conn.commit()
    conn.close()
    return redirect(url_for("home"))


    





if __name__ == "__main__":
    app.run(debug=True)
